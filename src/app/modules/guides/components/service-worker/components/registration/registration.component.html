<mat-card class="pwa-page" >
	<h4 id="introduction" pwa-query-selector>Регистрация сервисного рабочего.</h4>
	<p>Сервисный рабочий может значительно ускорить загрузку при повторных посещениях пользователя приложения, но разработчику следует предпринять шаги, которые гарантируют, что первоначальная установка сервисного рабочего не ухудшает пользовательского восприятия первого посещения. В целом, задержка регистрации сервисного рабочего до полной загрузки первой страницы приложения, способствует формированию хорошего впечатления пользователем, особенно на мобильных устройствах со слабым сигналом сети. </p>
	<h5 id="common-template" pwa-query-selector>Общий шаблон регистрации.</h5>
	<p>Обший подход обращается вокруг последовательности выражений:</p>
	<pwa-example-code [context]="{header : 'Инструкции регистрации', ext : 'app.js'}">
		<span class="dark-blue" >if (</span><span class="green" >'serviceWorker'</span> <span class="dark-blue" >in</span> <span class="purple" >navigator</span><span class="dark-blue" >) &#123;</span>
			<span class="purple" >navigator.</span><span class="dark-blue" >serviceWorker.register(</span><span class="green" >'/service-worker.js'</span><span class="dark-blue" >);
		&#125;</span>
	</pwa-example-code>
	<p>Эти выражения могут сопровождаться обращением к консоли для логирования действий регистрации <span class="dark-blue">console.log()</span> или кодом, определяющим наличие обновления предыдущей регистрации сервисного рабочего, как способом, дающим понятие пользователю о том, что страницу нужно обновить. Но все это - лишь небольшие вариации нескольких стандартных строчек кода. Но существуют ли ньюанся для метода регистрации <span class="dark-blue">navigator.serviceWorker.register()</span>? Каким наилутшим практикам следовать?</p>
	<h5 id="first-visit" pwa-query-selector>Первое посещение приложения.</h5>
	<p>При первом посещении пользователем приложения, ни один сервисный рабочий в браузере, согласно текущему домену, еще не установлен, и браузер не может знать заранее будет ли установлен какой-нибудь сервисный рабочий или нет. Разработчик должен быть уверен, что использованы все возможности для того, что бы браузер как можно скорее подгрузил минимальный набор ресурсов приложения, необходимый для отображения оболочки приложения. Если представить, что в процессе загрузки скриптов и изображений оболочки, браузер откроет новый поток или процесс (для краткости, предположим, что это поток). Предположим, что это происходит на слабой машине, и для обеспечения этого потока процессор тратит время и память, которые мог бы потратить браузер на обработку открытия оболочки приложения. Бездействующий поток, наврятли бы влиял на производительность процессора, но что если поток сам начинает загружать нужные ему ресурсы из сети. При этом возникает конкуренция за ресурсы процессора, пропускная способность сети для каждого потока снижается, что приводит к отрицательным последствиям для благоприятного восприятия пользователем вашего приложения.<br>
	Все это говорит о том, раскрученный поток устанавливающегося сервисного рабочего, загрузки ресурсов и кэширования их в фоне может работать против целей снижения времени до визуализации интерактивной страницы оболочки приложения. Но точное время старта регистрации может зависеть от того, что делает приложение сразу после загрузки. К примеру, если запускается стартовая анимация, было бы лутше отложить регистрацию до её окончания. Или если приложение использует фреймворк, который начинает дополнительные настройки или загрузки после события загрузки глобального контекста, поищите какое нибудь событие окончание предварительной работы этого фреймворка для сигнализирования окончания этой работы. </p>
	<h5 id="improving-boilerplate" pwa-query-selector>Совершенствуем шаблон.</h5>
	<p>Контроль старта регистрации сервисного рабочего заключается в определении момента запуска этой регистрации т.е. вызова метода <span class="dark-blue">navigator.serviceWorker.register()</span>. Простое правило - отложить регистрацию сервисного рабочего до события загрузки ресурсов глобальным контекстом. </p>
	<pwa-example-code [context]="{header : 'Задержка регистрации', ext : 'app.js'}">
		<span class="dark-blue" >if (</span><span class="green" >'serviceWorker'</span> <span class="dark-blue" >in</span> <span class="purple" >navigator</span><span class="dark-blue" >) &#123; </span>
			<span class="purple" >window.</span><span class="dark-blue" >addEventListener(</span><span class="green" >'load',</span> <span class="dark-sky" >function()</span> <span class="dark-blue" >&#123;</span>
				<span class="purple" >navigator.</span><span class="dark-blue" >serviceWorker.register(</span><span class="green" >'/service-worker.js'</span><span class="dark-blue" >);
			&#125;);
		&#125;</span>
	</pwa-example-code>
	<h5 id="subsequent-visits" pwa-query-selector>Последующие посешения.</h5>
	<p>Какое влияние оказывает отложенная регистрация сервисного рабочего на последующие посещения приложения пользователем? Никакого.<br>
	Когда сервисный рабочий регистрируется, он проходит через события жизненного цикла <span class="dark-blue">install</span> и <span class="dark-blue">activate</span>. Как только сервисный рабочий активизируется, он способен обрабатывать события <span class="dark-blue">fetch</span> последующих посещещений своих страниц. Сервисный рабочий запускается до старта первого запроса тех страниц, которые находятся в контексте его ответственности. Если текущий сервисный рабочий не был запущен ранее открывшейся страницы, он не сможет обрабатывать её сетевые запросы (методы <span class="dark-blue">fetch</span>). Как только появляется активный сервисный рабочий, не имеет значения когда был вызван метод <span class="dark-blue">navigator.serviceWorker.register()</span>, или вызван ли вообще, и если не менять <span class="dark-blue">URL</span> файла сервисного рабочего вызов метода регистрации никак не сказывается на последующие посещения.   </p>
	<h5 id="testing" pwa-query-selector>Тестирование.</h5>
	<p>Отличный способ симулировать первое посещение - это открыть приложение в режиме <a target="_blank" href="https://support.google.com/chromebook/answer/95464?co=GENIE.Platform%3DDesktop">Chrome Incognito</a> и посмотреть на сетевой трафик в инструментарии разработчика Chrome. Разработчик загружает локальную версию своего сайта, наверное, несколько раз в день, но перепосещение своего сайта, когда сервисный рабочий уже полностью заполнил необходимык кэши, не выявит потенциальные проблемы первичного запуска приложения. Ниже, пример, иллюстрирующий задержку регистрации и её отсутствие.Оба скриншота сделаны при посещении git страницы библиотеки <a target="_blank" href="https://github.com/GoogleChromeLabs/sw-precache/tree/master/app-shell-demo">sw-precache</a> в режиме браузера "Инкогнито", использую сетевой тротлинг и симуляцию низкого соединения.</p>
	<img  class="pageImg" src="assets/icons/registration/early-registration.png">
	<p>Скриншот выше отображает сетевой трафик, когда приложение было модифицированно для выполнения быстрой регистрации сервисного рабочего. Модно видет запросы предварительного кэширования (все запросы имеющие слева серую картинку и начинающиеся с файла <span class="dark-blue">service-worker.js</span>). </p>
	<img class="pageImg" src="assets/icons/registration/late-registration.png">
	<p>Скриншот выше отображает сетевой трафик при отложеной регистрации сервисного рабочего до момента загрузки ресурсов страницы. Можно видеть, что предварительное кэширование не запускается до тех пор, пока не загрузяться ресурсы глобального контекста, освобождая полосу сетевого пропускания. Кроме этого, из-за того, что некоторые файлы предварительного кэширования уже находятся в дисковом кэше (пометка размера загрузки  - <span class="dark-blue">from disk cache</span>), что избавляет от необходимости повторного запроса сервера. </p>
	<h5 id="conclusion" pwa-query-selector>Вывод.</h5>
	<p>Положительные пользовательские восприятия первого посещения приложения должны иметь высокий приоритет. Задерживая регистрацию сервисного рабочего до окончания загрузки ресурсов глобального контекста способствует этому, без каких либо артефактов при повторных посещениях. Наилутший способ гарантировать задержку, использовать выражения рассмотренные в листинге <span class="dark-blue">Задержка регистрации</span> .</p>
</mat-card>